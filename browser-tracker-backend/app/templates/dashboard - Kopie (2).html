{% extends "base.html" %}

{% block content %}
<section class="kpi-grid">
    <div class="kpi-card">
        <div class="kpi-label">Events gesamt</div>
        <div class="kpi-value">{{ total_events }}</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Nutzer</div>
        <div class="kpi-value">{{ total_users }}</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Sessions</div>
        <div class="kpi-value">{{ total_sessions }}</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Events letzte 24h</div>
        <div class="kpi-value">{{ events_last_24h }}</div>
    </div>
</section>

<style>
    /* Layout für die beiden Timelines nebeneinander */
    .chart-row {
        display: flex;
        gap: 1.5rem;
        align-items: stretch;
        margin-bottom: 2rem;
    }
    .chart-card {
        flex: 1;
        min-width: 0;
    }
    .chart-scroll-x {
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }
    .chart-card canvas {
        /* Deutlich flacher */
        max-height: 200px;
    }
    .chart-card h2 {
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
    }
</style>

<section class="chart-section chart-row">
    <div class="chart-card">
        <h2>Events pro Tag (letzte 365 Tage)</h2>
        <div class="chart-scroll-x">
            <canvas id="eventsByDayChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <h2>Events pro Stunde (heute)</h2>
        <canvas id="eventsByHourTodayChart"></canvas>
    </div>
</section>

<section class="grid-2">
    <div>
        <h2>Top Nutzer</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <!--<th>Nutzer</th>-->
                    <th>External ID</th>
                    <th>Events</th>
                </tr>
            </thead>
            <tbody>
            {% for u in top_users %}
                <tr>
                    <!--<td>{{ u.display_name or "-" }}</td>-->
                    <td>{{ u.external_id }}</td>
                    <td>{{ u.event_count }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div>
        <h2>Top Seiten</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>URL</th>
                    <th>Events</th>
                </tr>
            </thead>
            <tbody>
            {% for p in top_pages %}
                <tr>
                    <td class="truncate">{{ p.page_url }}</td>
                    <td>{{ p.event_count }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<script>
    // ==========================
    // Events pro Tag (letzte 365 Tage)
    // ==========================

    const eventsByDayLabels = [
        {% for r in events_by_day %}
            "{{ r.day }}",
        {% endfor %}
    ];
    const eventsByDayData = [
        {% for r in events_by_day %}
            {{ r.count }},
        {% endfor %}
    ];

    const ctxDay = document.getElementById('eventsByDayChart').getContext('2d');
    const eventsByDayChart = new Chart(ctxDay, {
        type: 'bar',
        data: {
            labels: eventsByDayLabels,
            datasets: [{
                label: 'Events pro Tag',
                data: eventsByDayData,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,  // Höhe via CSS
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Tag' },
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true
                    }
                },
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Events' }
                }
            }
        }
    });

    // ==========================
    // Events pro Stunde (heute), 24 Balken
    // ==========================

    const eventsByHourTodayRaw = {
    {% for r in events_by_hour_today %}
        "{{ r.hour }}": {{ r.count }}{% if not loop.last %},{% endif %}
    {% endfor %}
	};


    const hourLabels = [];
    const hourData = [];
    for (let h = 0; h < 24; h++) {
        const key = h.toString().padStart(2, '0');
        hourLabels.push(key + ":00");
        hourData.push(eventsByHourTodayRaw[key] || 0);
    }

    const ctxHour = document.getElementById('eventsByHourTodayChart').getContext('2d');
    const eventsByHourTodayChart = new Chart(ctxHour, {
        type: 'bar',
        data: {
            labels: hourLabels,
            datasets: [{
                label: 'Events pro Stunde',
                data: hourData,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,  // flach
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Stunde' },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 0
                    }
                },
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Events' }
                }
            }
        }
    });
</script>
{% endblock %}
